/*
 lichat 2016-05-01 
*/
app.controller("userController",["$scope","$location","$http","userService",function(a,b,c,d){a.pictureUrl="",a.username=b.search().username,a.currentUser=d.currentUser,a.level=0,a.lastVisit="",a.changeShow=!1,a.changePictureShow=!1;var e={username:a.username};a.getUserInfo=function(){c.post("server/getUserInfo.php",e).success(function(b){if(b){var c=JSON.parse(JSON.stringify(b));a.currentUser===c.username&&(a.changeShow=!0,a.changePictureShow=!0),a.pictureUrl=c.picture,d.pictureUrl=c.picture,a.level=c.level,a.lastVisit=c.visited}}).error(function(a){console.error(a)})},a.getUserInfo()}]),app.controller("loginController",["$scope","$http","$location","userService",function(a,b,c,d){a.loginResponse="",a.registerUrl="register",a.forgotUrl="forgot",a.loginInfo={username:void 0,password:void 0},a.loginUser=function(){var e={username:a.loginInfo.username,password:a.loginInfo.password};void 0!==e.username&&void 0!==e.password&&b.post("server/login.php",e).success(function(b){"S"===b.charAt(0)?(localStorage.setItem("token",JSON.parse(JSON.stringify(b))),d.token=localStorage.token,localStorage.setItem("name",e.username),d.setVisitDate(e.username),d.getUserInfo(e.username),c.path("/")):a.loginResponse=b}).error(function(a){console.error(a)})}}]),app.controller("registerController",["$scope","$http",function(a,b){a.loginUrl="login",a.registered=!1,a.registerShow=!0,a.registerInfo={username:void 0,password:void 0,email:void 0},a.registerResponse="",a.registerUser=function(){var c={username:a.registerInfo.username,password:a.registerInfo.password,email:a.registerInfo.email};void 0!==c.username&&void 0!==c.password&&void 0!==c.email&&b.post("server/register.php",c).success(function(b){"created"===b?(a.registerShow=!1,a.registered=!0):a.registerResponse=b}).error(function(a){console.error(a)})}}]),app.controller("homeController",["$scope","$http","userService",function(a,b,c){a.allThemes=[],a.showFrom=0,a.themeCount=0,a.showCount=10,a.paginationArray=[],a.getThemes=function(){var c=a.showFrom*a.showCount;b.post("server/getThemes.php",c).success(function(b){a.allThemes=JSON.parse(JSON.stringify(b)),a.getThemeCount()})},a.getThemeCount=function(){b.post("server/getThemeCount.php").success(function(b){a.themeCount=parseInt(b),a.buildPagination()})},a.ifCurrent=function(b){return b===a.showFrom?"active":void 0},a.gotoPage=function(b){a.showFrom=b,a.getThemes()},a.buildPagination=function(){a.paginationArray=[];var b=Math.ceil(a.themeCount/a.showCount);if(b>1)for(var c=0;b>c;c++)a.paginationArray.push(c)},a.showEdit=function(a){return a===c.currentUser||c.userLevel>=2},a.deleteTheme=function(b){var c=confirm("Are you sure?");c===!0&&a.removeTheme(b)},a.removeTheme=function(d){var e={username:c.currentUser,level:c.userLevel,token:c.token,id:d};b.post("server/deleteTheme.php",e).success(function(b){a.getThemes()}).error(function(a){console.error(a)})},a.getThemes()}]),app.controller("welcomeController",["$scope","$location","$http",function(a,b,c){a.welcomeUsername=localStorage.name;var d=localStorage.token;a.logout=function(){var e={token:d,username:a.welcomeUsername};c.post("server/logout.php",e).success(function(a){console.log(a),localStorage.clear(),b.path("/login")}).error(function(a){console.error(a)})}}]),app.controller("allusersController",["$scope","$http",function(a,b){a.allUsers=[],a.getAllUsers=function(){b.post("server/getAllUsers.php").success(function(b){b&&(a.allUsers=JSON.parse(JSON.stringify(b)))}).error(function(a){console.error(a)})},a.getAllUsers()}]),app.controller("backController",["$scope",function(a){a.goBack=function(){window.history.back()}}]),app.controller("pictureController",["$scope","$http","userService",function(a,b,c){a.pictureBoxShow=!1,a.pictureUrl=c.pictureUrl,a.pictureUrls=[],a.showChangePicture=function(){a.pictureBoxShow?a.pictureBoxShow=!1:(a.pictureBoxShow=!0,a.markSelectedPicture())},a.markSelectedPicture=function(){$(".choose-picture img").each(function(b){$(this).attr("src")===a.pictureUrl?$(this).attr("class","selected-picture"):$(this).attr("class","")})},a.getPicNames=function(){b.post("server/getPicNames.php").success(function(b){a.pictureUrls=JSON.parse(JSON.stringify(b))})},a.setImage=function(d){var e={pictureUrl:d,username:c.currentUser,token:c.token};b.post("server/setPicture.php",e).success(function(b){b&&(a.pictureUrl=d,a.markSelectedPicture())}).error(function(a){})},a.getPicNames()}]),app.controller("passwordController",["$scope","$http","userService",function(a,b,c){a.changeResponse="",a.newPassword="",a.newPassword2="",a.currentUser=c.currentUser,a.changePassword=function(){if(a.newPassword===a.newPassword2){var d={username:a.currentUser,newPassword:a.newPassword,token:c.token};b.post("server/changePassword.php",d).success(function(b){a.changeResponse=b,a.newPassword="",a.newPassword2=""}).error(function(a){console.error(a)})}else a.changeResponse="Your passwords doesn't match!"}}]),app.controller("addThemeController",["$scope","$http","userService",function(a,b,c){a.showAddTheme=!1,a.themeTitle="",a.themeDescription="",a.themeWaring="",a.pictureUrls=["img/default_theme.png","img/l_theme.png","img/music_theme.png","img/skull_theme.png","img/star_theme.png","img/paper_theme.png"],a.imageUrl="img/default_theme.png",a.titleMaxChars=150,a.descriptionMaxChars=2e3,a.descriptionCharsLeft=2e3,a.toogleAddTheme=function(){a.showAddTheme?a.showAddTheme=!1:(a.showAddTheme=!0,a.markSelectedPicture())},a.setImage=function(b){a.imageUrl=b,a.markSelectedPicture()},a.markSelectedPicture=function(){$(".choose-theme-picture img").each(function(b){$(this).attr("src")===a.imageUrl?$(this).attr("class","selected-picture"):$(this).attr("class","")})},a.updateDescriptionCharsLeft=function(){a.descriptionCharsLeft=c.calculateChars(a.descriptionMaxChars,a.themeDescription)},a.hideAddTheme=function(){a.showAddTheme=!1,a.themeWarning="",a.themeTitle="",a.themeDescription="",a.imageUrl="img/default_theme.png",a.showAddTheme=!1},a.addTheme=function(){if(a.themeTitle.length<=a.titleMaxChars&&a.themeDescription.length<=a.descriptionMaxChars&&""!==a.themeTitle){a.themeWarning="";var d={title:a.themeTitle,description:a.themeDescription,picture:a.imageUrl,owner:c.currentUser,token:c.token};b.post("server/addTheme.php",d).success(function(b){b?(a.themeWarning="",a.themeTitle="",a.themeDescription="",a.imageUrl="img/default_theme.png",a.showAddTheme=!1,a.getThemes()):a.themeWarning="Couldn't insert this theme"}).error(function(a){console.log(a)})}else a.themeWarning="Either theme title or description is too long or no theme title!"}}]),app.controller("editThemeController",["$scope","$http","userService",function(a,b,c){a.editTitle="",a.editDescription="",a.themeWaring="",a.pictureUrls=["img/default_theme.png","img/l_theme.png","img/music_theme.png","img/skull_theme.png","img/star_theme.png","img/paper_theme.png"],a.imageUrl="img/default_theme.png",a.titleMaxChars=150,a.descriptionMaxChars=2e3,a.editCharsLeft=2e3,a.showThis=!1,a.themeData=[],a.themeId=0,a.editTheme=function(b){a.getTheme(b),a.themeId=b},a.getTheme=function(c){b.post("server/getTheme.php",c).success(function(b){a.themeData=JSON.parse(JSON.stringify(b)),a.editTitle=a.themeData[1],a.editDescription=a.themeData[2],a.imageUrl=a.themeData[3],a.markSelectedPicture(),a.showThis=!0,setTimeout(function(){a.goToBottom()},200)}).error(function(a){console.error(a)})},a.goToBottom=function(a){var b=$("html, body");a?b.scrollTop(a):b.scrollTop(b.prop("scrollHeight"))},a.hideEditTheme=function(){a.showThis=!1,a.themeWarning="",a.editTitle="",a.editDescription="",a.imageUrl="img/default_theme.png",a.showAddTheme=!1},a.setEditImage=function(b){a.imageUrl=b,a.markSelectedPicture()},a.markSelectedPicture=function(){$(".choose-theme-picture img").each(function(b){$(this).attr("src")===a.imageUrl?$(this).attr("class","selected-picture"):$(this).attr("class","")})},a.updateEditCharsLeft=function(){a.editCharsLeft=c.calculateChars(a.descriptionMaxChars,a.editDescription)},a.updateTheme=function(){if(a.editTitle.length<=a.titleMaxChars&&a.editDescription.length<=a.descriptionMaxChars&&""!==a.editTitle){a.themeWarning="";var d={title:a.editTitle,description:a.editDescription,picture:a.imageUrl,owner:c.currentUser,id:a.themeId,token:c.token,level:c.userLevel};b.post("server/updateTheme.php",d).success(function(b){b?(a.themeWarning="",a.editTitle="",a.editDescription="",a.imageUrl="img/default_theme.png",a.showThis=!1,a.getThemes()):a.themeWarning="Couldn't update this theme"}).error(function(a){console.log(a)})}else a.themeWarning="Either theme title or description is too long or no theme title!"}}]),app.controller("themeController",["$scope","$http","$location","$sce","userService",function(a,b,c,d,e){a.oldMessages=[],a.allMessages=[],a.onlineUsers=[],a.themeData=[],a.id=c.search().id,a.messageText="",a.messageMaxChars=5e3,a.messageCharsLeft=a.messageMaxChars,a.messageWarning="",a.lastMessageCount=0,a.messageCount=0,a.firstMessagesLoaded=!1,a.messageLoadStep=10,a.messagesToLoad=10,a.messageLoadInterval=1540,a.checkForMessagesInt=1250,a.loaderVisible=!0,a.editOrEnter="Enter",a.editing=!1,a.displayCancel=!1,a.editId=0,a.editIndex=0,a.firstLoad=!0;var f=setInterval(function(){a.messageQuery()},a.messageLoadInterval),g=setInterval(function(){a.getNewMessages(),a.setVisitDate(),a.checkOnline()},a.checkForMessagesInt);a.messageQuery=function(){var b=$(".message-board"),c=a.lastMessageCount-a.messagesToLoad;b.scrollTop()<20&&(c>=0?(a.lastMessageCount>0&&(a.getMessages("old",c,a.messageLoadStep),a.messageLoadStep=5),0===c&&(a.loaderVisible=!1)):(a.messageLoadStep=a.messageLoadStep+c,c=0,a.getMessages("old",c,a.messageLoadStep),a.messageLoadStep=5,clearInterval(f),a.loaderVisible=!1))},a.showEditMessage=function(a){return a===e.currentUser||e.userLevel>=2},a.getNewMessages=function(){var b=($(".message-board"),a.lastMessageCount);if(a.lastMessageCount<a.messageCount){var c=a.messageCount-a.lastMessageCount;a.getMessages("new",b,c),a.lastMessageCount=a.messageCount}a.getMessageCount()},a.setVisitDate=function(){var a={username:e.currentUser,token:e.token};b.post("server/setVisitDate.php",a)},a.checkOnline=function(){b.post("server/checkOnline.php").success(function(b){a.onlineUsers=JSON.parse(JSON.stringify(b))})},a.goToBottom=function(b,c,d){window.setTimeout(function(){a.goBottom(b,d)},c)},a.goBottom=function(a,b){var c=$(".message-board");a?c.scrollTop(a):b?c.scrollTop()+445>=c.prop("scrollHeight")-40&&c.scrollTop(c.prop("scrollHeight")):c.scrollTop(c.prop("scrollHeight"))},a.getTheme=function(){b.post("server/getTheme.php",a.id).success(function(b){a.themeData=JSON.parse(JSON.stringify(b))}).error(function(a){console.error(a)})},a.getMessages=function(c,d,e){var f={id:a.id,startFrom:d,count:e};b.post("server/getMessages.php",f).success(function(b){a.messagesToLoad+=a.messageLoadStep;var d=[];d=JSON.parse(JSON.stringify(b)),"old"===c?0===a.allMessages.length?a.allMessages=d:(a.allMessages=$.merge(d,a.allMessages),a.goToBottom(100,200,!1)):"new"===c&&(a.allMessages=$.merge(a.allMessages,d),a.goToBottom(null,250,!0))}).error(function(a){console.error(a)})},a.getMessageCount=function(){window.setTimeout(function(){a.parseMessageCount()},100)},a.parseMessageCount=function(){b.post("server/getMessageCount.php",a.id).success(function(b){a.messageCount=parseInt(b),0===a.lastMessageCount&&(a.lastMessageCount=a.messageCount,a.firstMessagesLoaded||(a.firstMessagesLoaded=!0,a.messageQuery()))}).error(function(a){console.error(a)})},a.sendMessage=function(c){if(a.messageText.length<=5e3&&""!==a.messageText){a.messageWarning="";var d="server/sendMessage.php";a.editing&&(d="server/updateMessage.php");var f={username:e.currentUser,message:a.messageText,theme:a.id,token:e.token,messageId:a.editId,level:e.userLevel};b.post(d,f).success(function(b){a.editing&&(a.allMessages[a.editIndex][2]=a.messageText),a.messageText="",a.messageWarning="",a.messageCharsLeft=a.messageMaxChars,a.messageCount++,a.getNewMessages(),a.cancelEdit(),a.goToBottom(null,250,!1)}).error(function(b){a.messageWarning="Error while sendind message",console.error(b)})}else a.messageText.length>=5e3?a.messageWarning="Your message is too long!":a.messageWarning="Your message is too short!"},a.updateMessageChars=function(){a.messageCharsLeft=e.calculateChars(a.messageMaxChars,a.messageText)},a.editMessage=function(b,c,d){a.editOrEnter="Edit",a.editing=!0,a.displayCancel=!0,a.messageText=c,a.editId=b,a.editIndex=d},a.cancelEdit=function(){a.editOrEnter="Enter",a.editing=!1,a.displayCancel=!1,a.messageText="",a.editId=0,a.editIndex=0},a.deleteMessage=function(c,d){var f={username:e.currentUser,token:e.token,id:c,level:e.userLevel};b.post("server/deleteMessage.php",f).success(function(b){a.allMessages.splice(d,1)}).error(function(a){console.error(a)})},a.$on("lastElement",function(){var b=$(".message-board");(b.prop("scrollHeight")===b.scrollTop()+400||a.firstLoad)&&(a.firstLoad=!1,a.goToBottom(null,800,!1))}),a.$on("$destroy",function(){clearInterval(f),clearInterval(g)}),$(document).keypress(function(b){13===b.which&&a.sendMessage()}),a.getTheme(),a.getMessageCount()}]),app.controller("levelsController",["$scope","userService",function(a,b){a.showLevels=!1,a.checkIfAdmin=function(){3==b.userLevel&&(a.showLevels=!0)},a.checkIfAdmin()}]),app.controller("privilegesController",["$scope","$http","userService",function(a,b,c){a.allUsers=[],a.selectedUser=1,a.selectedLevel=1,a.allLevels=[],a.showWarning=!1,a.getAllUsers=function(){b.post("server/getAllUsers.php").success(function(b){b&&(a.allUsers=JSON.parse(JSON.stringify(b)))}).error(function(a){console.error(a)})},a.setLevel=function(){var d={setUser:a.selectedUser,setLevel:a.selectedLevel,username:c.currentUser,token:c.token,level:c.userLevel};b.post("server/setLevel.php",d).success(function(b){b&&(a.getAllUsers(),a.buildLevels(),a.showWarning=!0)})},a.buildLevels=function(){a.allLevels=[],a.allLevels=[0,1,2,3]},a.getAllUsers(),a.buildLevels()}]),app.controller("forgotController",["$scope","$http",function(a,b){a.loginUrl="login",a.reseted=!1,a.forgotShow=!0,a.username="",a.email="",a.forgotResponse="",a.resetPassword=function(){var c={username:a.username,email:a.email};b.post("server/forgotLogin.php",c).success(function(b){b?(a.reseted=!0,a.forgotShow=!1):a.forgotResponse="Could not find this user or email"})}}]),app.service("userService",["$http","$location",function(a,b){$this=this,$this.pictureUrl="",$this.currentUser=localStorage.name,$this.userLevel=localStorage.level,$this.token=localStorage.token,$this.userData=[],$this.getUserInfo=function(b){var c={username:b};a.post("server/getUserInfo.php",c).success(function(a){$this.userData=JSON.parse(JSON.stringify(a)),$this.userLevel=$this.userData.level,$this.currentUser=$this.userData.username,$this.token=$this.userData.token,localStorage.setItem("level",$this.userLevel)}).error(function(a){console.error(a)})},$this.setVisitDate=function(b){var c={username:b,token:$this.token};a.post("server/setVisitDate.php",c).success(function(a){a&&console.log("date set")}).error(function(a){console.error(a)})},$this.calculateChars=function(a,b){var c=a-parseInt(b.length);return c}}]);